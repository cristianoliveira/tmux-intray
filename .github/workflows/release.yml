name: Release

# Release automation for tmux-intray
# Optionally integrate with semantic-release by adding a job that:
# 1. Runs on push to main/develop
# 2. Uses semantic-release action to determine next version
# 3. Creates a tag and triggers this release workflow

on:
  push:
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'  # Matches semver tags like v1.2.3

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for creating releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Verify version consistency
        run: |
          # Version is now managed through Go ldflags during build
          # We just need to verify the tag follows semantic versioning
          TAG_VERSION="${{ steps.tag.outputs.VERSION }}"
          # Remove leading 'v' from tag for verification
          TAG_VERSION="${TAG_VERSION#v}"
          if ! echo "$TAG_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
            echo "Error: Invalid version format in tag"
            echo "  Expected format: v1.2.3"
            echo "  Got tag: ${{ steps.tag.outputs.VERSION }}"
            exit 1
          fi
          echo "✓ Version format validated: $TAG_VERSION"

      - name: Generate documentation
        run: |
          ./scripts/generate-docs.sh

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
          cache-dependency-path: go.sum

      - name: Build Go binaries
        env:
          VERSION: ${{ steps.tag.outputs.VERSION }}
        run: |
          mkdir -p dist
          # Remove leading 'v' from version for ldflags
          VERSION="${VERSION#v}"
          PLATFORMS="linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64"
          for PLATFORM in $PLATFORMS; do
            GOOS=${PLATFORM%/*}
            GOARCH=${PLATFORM#*/}
            output="dist/tmux-intray_${GOOS}_${GOARCH}"
            if [ "$GOOS" = "windows" ]; then output="${output}.exe"; fi
            GOOS=$GOOS GOARCH=$GOARCH go build -ldflags="-X github.com/cristianoliveira/tmux-intray/cmd.Version=$VERSION" -o "$output" ./cmd/tmux-intray
            echo "Built: $output"
          done

      - name: Verify built binaries
        run: |
          echo "Verifying built binaries..."
          for binary in dist/tmux-intray_*; do
            if [[ "$binary" == *.exe ]]; then
              # Windows binary - just check file exists and has content
              if [ -f "$binary" ] && [ -s "$binary" ]; then
                echo "✓ Windows binary verified: $(basename "$binary")"
              else
                echo "✗ Windows binary failed: $(basename "$binary")"
                exit 1
              fi
            else
              # Unix-like binary - check if executable and reports version
              if [ -x "$binary" ]; then
                version_output=$("$binary" version 2>&1 || true)
                if [[ "$version_output" == *"tmux-intray v"* ]]; then
                  echo "✓ Unix binary verified: $(basename "$binary")"
                else
                  echo "⚠ Unix binary version check failed: $(basename "$binary")"
                  echo "  Output: $version_output"
                fi
              else
                echo "✗ Unix binary not executable: $(basename "$binary")"
                exit 1
              fi
            fi
          done

      - name: Generate release notes
        id: release-notes
        run: |
          # Get all semver tags sorted by version (newest first)
          mapfile -t ALL_TAGS < <(git tag --list 'v*' --sort=-v:refname 2>/dev/null || true)
          CURRENT_TAG="${{ steps.tag.outputs.VERSION }}"
          PREVIOUS_TAG=""
          # Find the tag immediately before current tag
          for t in "${ALL_TAGS[@]}"; do
            if [ "$t" != "$CURRENT_TAG" ]; then
              PREVIOUS_TAG="$t"
              break
            fi
          done

          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: ${PREVIOUS_TAG:-none}"

          # Generate changelog
          if [ -z "$PREVIOUS_TAG" ]; then
            # No previous tag, include all commits
            CHANGELOG=$(git log --oneline --no-merges --format="- %s (%h)" HEAD)
          else
            # Get commits between previous tag and current tag
            CHANGELOG=$(git log --oneline --no-merges --format="- %s (%h)" "$PREVIOUS_TAG"..HEAD)
          fi

          # Format for GitHub release notes
          RELEASE_NOTES="# $CURRENT_TAG"
          RELEASE_NOTES+=$'\n\n'
          RELEASE_NOTES+="## Changelog"
          RELEASE_NOTES+=$'\n\n'
          RELEASE_NOTES+="$CHANGELOG"
          # Output for next step (using environment file)
          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_ENV"
          echo "$RELEASE_NOTES" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Create source tarball
        id: package
        run: |
          mkdir -p dist
          TAG="${{ steps.tag.outputs.VERSION }}"
          # Create a tarball of the repository (excluding .git and temporary directories)
          tar -czf "dist/tmux-intray-${TAG}.tar.gz" \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='.tmp' \
            --exclude='.bv' \
            --exclude='.local' \
            --exclude='tmp' \
            --exclude='*.swp' \
            .
          echo "TARBALL_PATH=dist/tmux-intray-${TAG}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew formula
        run: |
          # Switch to main branch
          git checkout main
          git pull origin main
          # Compute SHA256 of the source tarball
          TARBALL="${{ steps.package.outputs.TARBALL_PATH }}"
          NEW_SHA256=$(shasum -a 256 "$TARBALL" | awk '{print $1}')
          # Extract version from tag (remove leading v)
          VERSION="${{ steps.tag.outputs.VERSION }}"
          VERSION="${VERSION#v}"
          # Update formula file using Ruby
          ruby -i -pe "
            if /^\s*version\s+\"/ && !\$updated_version
              gsub(/\"[^\"]+\"/, '\"#{VERSION}\"')
              \$updated_version = true
            end
            if /^\s*url\s+\".*\/v[^\"]+\.tar\.gz\"/ && !\$updated_url
              gsub(/\/v[^\"]+\.tar\.gz/, \"/v#{VERSION}.tar.gz\")
              \$updated_url = true
            end
            if /^\s*sha256\s+\"/ && !\$updated_sha
              gsub(/\"[^\"]+\"/, '\"#{NEW_SHA256}\"')
              \$updated_sha = true
            end
          " Formula/tmux-intray.rb
          # Commit changes if any
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Formula/tmux-intray.rb
          if ! git diff --cached --quiet; then
            git commit -m "chore(ci): update homebrew formula to v${VERSION}"
            git push origin main
          else
            echo "No changes to formula."
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.tag.outputs.VERSION }}
          body: ${{ env.RELEASE_NOTES }}
          draft: false
          prerelease: false
          generate_release_notes: false  # We generate our own
          files: |
            ${{ steps.package.outputs.TARBALL_PATH }}
            dist/tmux-intray_*
