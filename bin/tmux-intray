#!/usr/bin/env bash
# Main entry point for tmux-intray CLI

set -euo pipefail

VERSION="0.1.0"
# Resolve symlinks to get the real script path
realpath() {
    local path="$1"
    local dir
    if dir="$(cd "$(dirname "$path")" && pwd)" && [ -f "$dir/$(basename "$path")" ]; then
        echo "$dir/$(basename "$path")"
    else
        echo "$path"
    fi
}
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
# If script source is a symlink, resolve it
if [ -L "$SCRIPT_SOURCE" ]; then
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    # If readlink returns relative path, make absolute relative to original dir
    if [[ "$SCRIPT_SOURCE" != /* ]]; then
        SCRIPT_SOURCE="$(dirname "${BASH_SOURCE[0]}")/$SCRIPT_SOURCE"
    fi
fi
SCRIPT_DIR="$( cd "$( dirname "$SCRIPT_SOURCE" )" && pwd )"
# If running under Bats, use the original test directory to locate project root
if [[ -n "${BATS_TEST_DIRNAME:-}" && -d "${BATS_TEST_DIRNAME}" ]]; then
    PROJECT_ROOT="$(cd "$BATS_TEST_DIRNAME/.." && pwd)"
else
    # Try to find the original project root by looking for go.mod
    find_project_root() {
        local dir="$1"
        while [[ "$dir" != "/" ]]; do
            if [[ -f "$dir/go.mod" ]]; then
                echo "$dir"
                return 0
            fi
            dir="$(dirname "$dir")"
        done
        echo "$1"
    }
    PROJECT_ROOT="$(find_project_root "$SCRIPT_DIR")"
fi
export TMUX_INTRAY_ROOT="$PROJECT_ROOT"

# If TMUX_INTRAY_BIN is set, execute that binary
if [[ -n "${TMUX_INTRAY_BIN:-}" ]]; then
    if [[ ! -x "$TMUX_INTRAY_BIN" ]]; then
        echo "Error: TMUX_INTRAY_BIN is set to '$TMUX_INTRAY_BIN' but it's not executable" >&2
        exit 1
    fi
    echo "Executing $TMUX_INTRAY_BIN" >&2
    exec "$TMUX_INTRAY_BIN" "$@"
fi

# If TMUX_INTRAY_IMPL is set to "go", execute the Go binary
if [[ "${TMUX_INTRAY_IMPL:-}" == "go" ]]; then
    GO_BIN="$PROJECT_ROOT/bin/tmux-intray-go"
    if [[ ! -x "$GO_BIN" ]]; then
        echo "Error: Go binary not found at '$GO_BIN'. Build it with 'make go-build'." >&2
        exit 1
    fi
    exec "$GO_BIN" "$@"
fi

COMMANDS_DIR="$PROJECT_ROOT/commands"
LIB_DIR="$PROJECT_ROOT/lib"

# Source core libraries
source "$LIB_DIR/colors.sh"
source "$LIB_DIR/core.sh"

usage() {
    cat << EOF
tmux-intray v${VERSION}

A quiet inbox for things that happen while you're not looking.

USAGE:
    tmux-intray [COMMAND] [OPTIONS]

COMMANDS:
    add <message>   Add a new item to the tray
    list            List notifications with filters and formats
    dismiss <id>    Dismiss a notification
    clear           Clear all items from the tray
    cleanup         Clean up old dismissed notifications
    toggle          Toggle the tray visibility
    jump <id>       Jump to the pane of a notification
    status          Show notification status summary
    status-panel    Status bar indicator script (for tmux status-right)
    follow          Monitor notifications in real-time
    help            Show this help message
    version         Show version information

OPTIONS:
    -h, --help      Show help message

EOF
}

main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    local command="$1"
    shift || true

    case "$command" in
        add|clear|cleanup|toggle|help|version|list|dismiss|jump|status|follow|status-panel)
            # Load and execute the command
            source "$COMMANDS_DIR/${command}.sh"
            local cmd_func="${command//-/_}_command"
            "$cmd_func" "$@"
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        *)
            error "Unknown command '$command'"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
